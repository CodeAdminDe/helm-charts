apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-run
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ollama.labels" . | nindent 4 }}
data:
data:
  run.sh: |
    #!/bin/sh
    #/bin/sh
    set -e

    echo "Pull or build requested models, if any..."

    if [ -n "${PREPULL_MODEL_LIST}" ]; then
      echo "Starting ollama to allow pulling/creating..."
      ollama serve &

      echo "Check if ollama is reachable..."
      while ! ollama ps >/dev/null 2>&1; do
        echo "Not reachable... Waiting for ollama ..."
        sleep 1
      done
      echo "Ollama is reachable..."

      WORKDIR="/tmp/codeadmin-models"
      mkdir -p "$WORKDIR"

      for ENTRY in $(echo "$PREPULL_MODEL_LIST" | tr ',' '\n'); do
        # default - pull model
        if ! echo "$ENTRY" | grep -q '@'; then
          echo "Pull base model: $ENTRY..."
          ollama pull "$ENTRY" || echo "WARN: pull failed for $ENTRY"
          continue
        fi

        # modelfile - create model from repo Modelfiles
        #   NAME@REPO_URL:PATH/TO/Modelfile
        NAME="${ENTRY%%@*}"
        REST="${ENTRY#*@}"
        REPO_URL="${REST%%:*}"
        FILE_PATH="${REST#*:}"

        echo "Build custom model '$NAME' from $REPO_URL ($FILE_PATH)..."

        REPO_DIR="$WORKDIR/$(echo "$REPO_URL" | tr '/' '_' | tr ':' '_')"
        if [ -d "$REPO_DIR" ]; then
          echo "Repo dir exists, pulling latest..."
          (cd "$REPO_DIR" && git pull --rebase || true)
        else
          echo "Shallow sparse-clone of $REPO_URL..."
          git clone --depth 1 --filter=blob:none --no-checkout "$REPO_URL" "$REPO_DIR"
          (
            cd "$REPO_DIR"
            git sparse-checkout init --cone
            git sparse-checkout set "$(dirname "$FILE_PATH")"
            git checkout
          )
        fi

        MODEFILE="$REPO_DIR/$FILE_PATH"
        if [ ! -f "$MODEFILE" ]; then
          echo "WARN: Modelfile $MODEFILE not found, skipping $NAME"
          continue
        fi

        ollama create "$NAME" -f "$MODEFILE" || echo "WARN: create failed for $NAME"
      done
    else
      echo "No models for pre-pull/pre-build requested."
    fi

    echo "Initialization done. Exiting."
    exit 0
