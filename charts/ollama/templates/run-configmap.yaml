apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-run
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ollama.labels" . | nindent 4 }}
data:
  run.sh: |
    #/bin/sh

    echo "Pull requested models, if any..."
    if [ -n "${PREPULL_MODEL_LIST}" ]; then
      echo "Starting ollama to allow pulling..."
      ollama serve &

      echo "Check if ollama is reachable..."
      while ! ollama ps; do
        echo "Not reachable... Waiting for ollama ..."
        sleep 1
      done
      echo "Ollama is reachable..."
      echo "Pulling requested models..."
      for MODEL in $(echo $PREPULL_MODEL_LIST | tr ',' '\n'); do
        ollama pull "$MODEL"
      done

    if [ -n "${PREBUILD_MODEL_LIST}" ]; then
      echo "Creating custom models from Modelfiles..."
      IFS=',' read -r -a ENTRIES <<< "$PREBUILD_MODEL_LIST"
      for ENTRY in "${ENTRIES[@]}"; do
        NAME="${ENTRY%%:*}"
        FILE="${ENTRY#*:}"
        echo "Create $NAME from $FILE..."
        if [ -f "$FILE" ]; then
          ollama create "$NAME" -f "$FILE"
        else
          echo "WARNING: Modelfile $FILE not found, skipping $NAME"
        fi
      done
    else
      echo "No custom models requested for build."
    fi
    
    else
      echo "No models for pre-pull or pre-build requested."
    fi

    echo "Initialization done. Exiting."
    exit 0
